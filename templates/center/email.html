<div class="campaign-email" role="region" aria-label="Create a New Campaign Email">
  <header class="campaign-email__header">
    <h2 class="text-wrapper-7">Create a New Campaign Email</h2>
  </header>

  <section class="campaign-email__recipients" aria-labelledby="send-to-heading">
    <p id="send-to-heading" class="campaign-email__label">Send to (1)</p>

    <div class="campaign-email__chips" aria-label="Selected recipients and segments">
      <span class="campaign-chip">
        <span class="campaign-chip__avatar" aria-hidden="true">
          <img src="/static/img/brandon.jpg" alt="" />
        </span>
        <span class="campaign-chip__text">Test Customer (test@email.com)</span>
      </span>
    </div>

    <label class="campaign-checkbox">
      <input type="checkbox" name="send_all" />
      <span>Send to all customers</span>
    </label>
  </section>

  <hr class="campaign-divider" />

  <section class="campaign-email__compose" aria-labelledby="subject-heading">
    <h3 id="subject-heading" class="campaign-email__subject">VIP Yoga Event - 2026</h3>

    <div class="campaign-email__toolbar-row">
      <div class="campaign-toolbar" role="toolbar" aria-label="Email editor toolbar">
        <button type="button" class="campaign-toolbar__btn campaign-toolbar__btn--dropdown" aria-label="Font family">
          Figtree
          <span class="campaign-toolbar__caret" aria-hidden="true">â–¾</span>
        </button>
        <button type="button" class="campaign-toolbar__btn campaign-toolbar__btn--dropdown" aria-label="Text style">
          Tt
          <span class="campaign-toolbar__caret" aria-hidden="true">â–¾</span>
        </button>
        <span class="campaign-toolbar__sep" aria-hidden="true"></span>
        <button type="button" class="campaign-toolbar__btn" aria-label="Bold"><strong>B</strong></button>
        <button type="button" class="campaign-toolbar__btn" aria-label="Italic"><em>I</em></button>
        <button type="button" class="campaign-toolbar__btn" aria-label="Underline"><span class="campaign-u">U</span></button>
        <button type="button" class="campaign-toolbar__btn" aria-label="Strikethrough"><span class="campaign-s">S</span></button>
        <span class="campaign-toolbar__sep" aria-hidden="true"></span>
        <button type="button" class="campaign-toolbar__btn" aria-label="Insert image">ðŸ–¼</button>
        <button type="button" class="campaign-toolbar__btn" aria-label="Code view">&lt;/&gt;</button>
      </div>

      <button type="button" class="campaign-btn campaign-btn--ghost">
        <span aria-hidden="true">+</span>
        Apply Template
      </button>
    </div>

    <div class="campaign-editor-wrapper">
    <div class="campaign-editor" role="textbox" aria-label="Email body" contenteditable="true" spellcheck="false">
      <p><strong>Hello!</strong></p>
      <p>
        Join us for VIP Yoga Event - 2026, an event dedicated to movement, mindfulness, and community. Enjoy energizing outdoor yoga
        sessions, guided meditation, live music, and workshops led by inspiring instructors from around the region. Whether you're new to yoga
        or a long-time practitioner, this event is designed to help you recharge, connect, and celebrate the joy of summer together.
      </p>
      <p>
        We'd love to have you with us. Save your spot today and be part of an uplifting experience that brings people together through wellness
        and intention. We can't wait to flow, breathe, and celebrate with you at VIP Yoga Event - 2026.
      </p>
      <p>Warmly,<br />Vygor Test</p>
    </div>
    <div id="text-selection-menu" class="text-selection-menu" role="toolbar" aria-label="AI Personalize" style="display: none;">
      <button type="button" class="text-selection-menu__btn" id="ai-personalize-btn" aria-label="AI Personalize">AI Personalize</button>
    </div>
    </div>
  </section>

  <hr class="campaign-divider" />

  <section class="campaign-email__test" aria-labelledby="test-heading">
    <h3 id="test-heading" class="campaign-email__section-title">Test</h3>

    <div class="campaign-input-wrapper">
      <input
        id="test-customer"
        class="campaign-input"
        type="search"
        placeholder="Search for Name, Phone, or Email"
        autocomplete="off"
      />
      <div id="test-customer-dropdown" class="campaign-input-dropdown" role="listbox" aria-label="Customer suggestions" style="display: none;">
        <button type="button" class="campaign-input-dropdown__item" role="option" data-value="Test Customer (test@email.com)">
          <span class="campaign-input-dropdown__avatar" aria-hidden="true">
            <img src="/static/img/brandon.jpg" alt="" />
          </span>
          <div class="campaign-input-dropdown__info">
            <span class="campaign-input-dropdown__name">Test Customer</span>
            <span class="campaign-input-dropdown__email">test@email.com</span>
          </div>
        </button>
      </div>
    </div>

    <div class="campaign-preview" aria-label="Email preview">
      <p><strong>Hello!</strong></p>
      <p>
        Join us for VIP Yoga Event - 2026, an event dedicated to movement, mindfulness, and community. Enjoy energizing outdoor yoga
        sessions, guided meditation, live music, and workshops led by inspiring instructors from around the region. Whether you're new to yoga
        or a long-time practitioner, this event is designed to help you recharge, connect, and celebrate the joy of summer together.
      </p>
      <p>
        We'd love to have you with us. Save your spot today and be part of an uplifting experience that brings people together through wellness
        and intention. We can't wait to flow, breathe, and celebrate with you at VIP Yoga Event - 2026.
      </p>
      <p>Warmly,<br />Vygor Test</p>
    </div>
  </section>

  <footer class="campaign-email__actions" aria-label="Campaign actions">
    <button type="button" class="campaign-btn campaign-btn--pill">
      Send Now
    </button>
    <button type="button" class="campaign-btn campaign-btn--pill">
      Schedule Send
    </button>
    <button type="button" class="campaign-btn campaign-btn--primary">Save Draft</button>
    <button type="button" class="campaign-btn campaign-btn--danger">Discard</button>
  </footer>
</div>

<script>
  (function() {
    const editor = document.querySelector('.campaign-editor');
    const editorWrapper = document.querySelector('.campaign-editor-wrapper');
    const menu = document.getElementById('text-selection-menu');
    
    if (!editor || !menu || !editorWrapper) return;
    
    function getSelectionRect() {
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) return null;
      
      const range = selection.getRangeAt(0);
      if (range.collapsed) return null;
      
      // Check if selection is within the editor
      if (!editor.contains(range.commonAncestorContainer)) return null;
      
      const rect = range.getBoundingClientRect();
      const wrapperRect = editorWrapper.getBoundingClientRect();
      
      return {
        top: rect.top - wrapperRect.top + editorWrapper.scrollTop,
        left: rect.left - wrapperRect.left + editorWrapper.scrollLeft,
        width: rect.width,
        height: rect.height
      };
    }
    
    function showMenu() {
      const rect = getSelectionRect();
      if (!rect) {
        menu.style.display = 'none';
        return;
      }
      
      // Force layout calculation
      menu.style.display = 'flex';
      const menuRect = menu.getBoundingClientRect();
      const wrapperRect = editorWrapper.getBoundingClientRect();
      
      let top = rect.top - menuRect.height - 8;
      let left = rect.left + (rect.width / 2) - (menuRect.width / 2);
      
      // Keep menu within wrapper bounds
      if (left < 8) left = 8;
      if (left + menuRect.width > wrapperRect.width - 8) {
        left = wrapperRect.width - menuRect.width - 8;
      }
      if (top < 8) {
        top = rect.top + rect.height + 8;
      }
      
      menu.style.top = top + 'px';
      menu.style.left = left + 'px';
    }
    
    function hideMenu() {
      menu.style.display = 'none';
    }
    
    function handleAIPersonalize() {
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) return;
      
      const range = selection.getRangeAt(0);
      if (range.collapsed) {
        hideMenu();
        return;
      }
      
      // Create a span with green highlight styling
      const span = document.createElement('span');
      span.className = 'ai-personalized-text';
      
      try {
        // Wrap the selected content
        range.surroundContents(span);
      } catch (e) {
        // If surroundContents fails (e.g., selection spans multiple nodes),
        // extract content and replace
        const contents = range.extractContents();
        span.appendChild(contents);
        range.insertNode(span);
      }
      
      // Clear selection
      selection.removeAllRanges();
      
      hideMenu();
      editor.focus();
    }
    
    // Handle text selection
    editor.addEventListener('mouseup', function() {
      setTimeout(showMenu, 10);
    });
    
    editor.addEventListener('keyup', function(e) {
      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
          e.key === 'ArrowUp' || e.key === 'ArrowDown' ||
          e.shiftKey) {
        setTimeout(showMenu, 10);
      }
    });
    
    // Hide menu when clicking outside or selection is cleared
    document.addEventListener('mousedown', function(e) {
      if (!menu.contains(e.target) && !editorWrapper.contains(e.target)) {
        hideMenu();
      }
    });
    
    // Handle AI Personalize button click
    const aiPersonalizeBtn = document.getElementById('ai-personalize-btn');
    if (aiPersonalizeBtn) {
      aiPersonalizeBtn.addEventListener('click', handleAIPersonalize);
    }
    
    // Hide menu when selection changes programmatically
    document.addEventListener('selectionchange', function() {
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
        hideMenu();
      }
    });
  })();

  // Test customer input dropdown
  (function() {
    const input = document.getElementById('test-customer');
    const dropdown = document.getElementById('test-customer-dropdown');
    const wrapper = document.querySelector('.campaign-input-wrapper');
    const preview = document.querySelector('.campaign-preview');
    
    if (!input || !dropdown || !wrapper || !preview) return;
    
    function showDropdown() {
      dropdown.style.display = 'block';
    }
    
    function hideDropdown() {
      // Delay to allow click events on dropdown items
      setTimeout(() => {
        dropdown.style.display = 'none';
      }, 200);
    }
    
    function updatePreview(customerName) {
      // Update the preview with personalized text after a 2s delay
      setTimeout(() => {
        const name = customerName.split(' (')[0]; // Extract name from "Name (email)"
        preview.innerHTML = `
          <p><strong>Hi ${name}!</strong></p>

          <p>Thanks for coming to class again last week â€” we always appreciate seeing you on the mat.</p>

          <p>Because you're one of our most dedicated members and clearly value your yoga practice, we wanted to reach out with something special just for you.</p>
          <p>
            Join us for VIP Yoga Event - 2026, a weekend dedicated to movement, mindfulness, and community. Enjoy energizing outdoor yoga
            sessions, guided meditation, live music, and workshops led by inspiring instructors from around the region. Whether you're new to yoga
            or a long-time practitioner, this event is designed to help you recharge, connect, and celebrate the joy of summer together.
          </p>
          <p>
            We'd love to have you with us. Save your spot today and be part of an uplifting experience that brings people together through wellness
            and intention. We can't wait to flow, breathe, and celebrate with you at VIP Yoga Event - 2026.
          </p>
          <p>Warmly,<br />Vygor Test</p>
        `;
      }, 2000);
    }
    
    function selectItem(value, customerName) {
      input.value = value;
      hideDropdown();
      input.focus();
      updatePreview(customerName);
    }
    
    // Show dropdown on focus
    input.addEventListener('focus', showDropdown);
    
    // Hide dropdown on blur (unless clicking inside dropdown)
    input.addEventListener('blur', hideDropdown);
    
    // Handle dropdown item clicks
    dropdown.addEventListener('click', function(e) {
      const item = e.target.closest('.campaign-input-dropdown__item');
      if (item) {
        const value = item.getAttribute('data-value');
        const nameElement = item.querySelector('.campaign-input-dropdown__name');
        const customerName = nameElement ? nameElement.textContent : value;
        if (value) {
          selectItem(value, customerName);
        }
      }
    });
    
    // Prevent blur when clicking inside dropdown
    dropdown.addEventListener('mousedown', function(e) {
      e.preventDefault();
    });
    
    // Filter dropdown items based on input
    input.addEventListener('input', function() {
      const searchTerm = input.value.toLowerCase();
      const items = dropdown.querySelectorAll('.campaign-input-dropdown__item');
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    });
  })();
</script>
