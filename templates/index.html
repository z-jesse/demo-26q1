<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Vygor - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/globals.css" />
    <link rel="stylesheet" href="/static/styleguide.css" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="base" data-colors-mode="dark">
      <aside class="frame" role="navigation" aria-label="Main navigation">
        <div class="div-wrapper">
          <h1 class="text-wrapper">Vygor</h1>
        </div>
        <nav class="div">
          <button class="frame-2" data-colors-mode="dark" aria-label="Chat">
            <img class="img" src="/static/img/sparkles-two-ai-2-stars-sparkles.svg" alt="" aria-hidden="true" />
            <span class="text-wrapper-2">Chat</span>
          </button>
          <ul class="frame-3" data-colors-mode="dark">
            <li>
              <a href="/" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/home-roof-house.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Dashboard</span>
              </a>
            </li>
            <li>
              <a href="#checkin" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/clipboard-2-copy-list.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Check In</span>
              </a>
            </li>
            <li>
              <a href="#pos" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/store-shop-business.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Point of Sale</span>
              </a>
            </li>
            <li>
              <a href="#schedule" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/calendar-3-date.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Schedule</span>
              </a>
            </li>
            <li>
              <a href="#classes" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/people-2-user-avatar-group.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Classes</span>
              </a>
            </li>
            <li>
              <a href="#memberships" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/crown-vip.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Memberships</span>
              </a>
            </li>
            <li>
              <a href="#customers" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/people-user-person-avatar.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Customers</span>
              </a>
            </li>
            <li>
              <a href="#communications" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/bubble-2-message.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Communications</span>
              </a>
            </li>
            <li>
              <a href="#analytics" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/chart-5-statistics-graph.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Analytics</span>
              </a>
            </li>
            <li>
              <a href="#team" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/postcard-card-news.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Team</span>
              </a>
            </li>
            <li>
              <a href="#settings" class="frame-4" data-colors-mode="dark">
                <img class="img" src="/static/img/settings-gear-2-preferences.svg" alt="" aria-hidden="true" />
                <span class="text-wrapper-3">Settings</span>
              </a>
            </li>
          </ul>
        </nav>
        <div class="frame-wrapper">
          <div class="frame-5" data-colors-mode="dark">
            <img class="frame-6" src="/static/img/panther.jpg" alt="Vygor Test logo" />
            <div class="frame-7">
              <div class="text-wrapper-4">Vygor Test</div>
              <div class="text-wrapper-5">Yoga Studio</div>
            </div>
          </div>
        </div>
      </aside>
      <main class="frame-8">
        <header class="frame-9">
          <div class="search-field" data-colors-mode="dark">
            <form class="field" role="search" aria-label="Search">
              <img class="img" src="/static/img/magnifying-glass-search.svg" alt="" aria-hidden="true" />
              <label for="search-input" class="visually-hidden">Search</label>
              <input id="search-input" class="search" placeholder="Search" type="search" name="search" />
            </form>
          </div>
          <div class="frame-10">
            <button class="frame-11" data-colors-mode="dark" aria-label="Point of Sale">
              <img class="img-2" src="/static/img/store-shop-business-yellow.svg" alt="" aria-hidden="true" />
              <span class="text-wrapper-6">PoS</span>
            </button>
            <button class="frame-11" data-colors-mode="dark" aria-label="Check In">
              <img class="img-2" src="/static/img/clipboard-2-copy-list-yellow.svg" alt="" aria-hidden="true" />
              <span class="text-wrapper-6">Check In</span>
            </button>
            <button class="frame-12" aria-label="User menu">
              <img class="ellipse" src="/static/img/woman-avatar.jpg" alt="Test User avatar" />
              <span class="text-wrapper-3">Test User</span>
              <img class="img-3" src="/static/img/chevron-down-small.svg" alt="" aria-hidden="true" />
            </button>
          </div>
        </header>
        <div class="frame-13" data-colors-mode="dark">
          <div class="frame-14">
            {% include (center_template or "center/dashboard.html") %}
          </div>
          <aside class="frame-23" aria-label="AI Assistant">
            <div class="frame-24" aria-live="polite">
              {% if response %}
                <pre class="p" id="assistant-response">{{ response }}</pre>
              {% else %}
                <pre class="p" id="assistant-response"></pre>
              {% endif %}
            </div>
            <div class="frame-25">
              <form id="assistant-form" method="post" action="{{ url_for('home', center=center_key) }}">
                <textarea
                  id="prompt-input"
                  name="prompt"
                  class="p"
                  placeholder="How can Vygor Intelligence help?"
                  autocomplete="off"
                  rows="3"
                >{{ user_prompt or "" }}</textarea>
              </form>
            </div>
          </aside>
        </div>
      </main>
    </div>

    <script>
      (function () {
        const form = document.getElementById("assistant-form");
        const textarea = document.getElementById("prompt-input");
        const out = document.getElementById("assistant-response");
      
        if (!form || !textarea || !out) return;
      
        let evtSource = null;
      
        function submitPrompt() {
          // Remove all whitespace including Mac line endings (\r), newlines (\n), tabs, and spaces
          const prompt = (textarea.value || "").replace(/[\r\n\t]/g, '').trim();
          if (!prompt) return;
      
          // If input is "yes", switch to email view
          if (prompt.toLowerCase() === "yes") {
            const url = new URL(window.location.href);
            url.searchParams.set('center', 'email');
            window.location.href = url.toString();
            return;
          }
      
          // Clean previous stream if any
          if (evtSource) {
            evtSource.close();
            evtSource = null;
          }
      
          textarea.disabled = true;
          out.innerHTML = "";  // clear previous content
      
          evtSource = new EventSource(`/api/stream?prompt=${encodeURIComponent(prompt)}`, { withCredentials: false });
      
          evtSource.onmessage = function (event) {
            const msg = event.data;
      
            // Append the chunk (already contains <br> from server)
            out.innerHTML += msg;
      
            // Scroll to bottom
            out.scrollTop = out.scrollHeight;
          };
      
          evtSource.onerror = function () {
            // out.innerHTML += '<br><span style="color: #dc2626;">Connection error â€” please try again.</span>';
            evtSource.close();
            evtSource = null;
            textarea.disabled = false;
            textarea.focus();
          };
      
          evtSource.addEventListener("close", () => {
            evtSource.close();
            evtSource = null;
            textarea.disabled = false;
            textarea.focus();
          });
      
          // Optional: clear input right away
          textarea.value = "";
        }
      
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          submitPrompt();
        });
      
        textarea.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            submitPrompt();
          }
        });
      })();
      </script>
  </body>
</html>
